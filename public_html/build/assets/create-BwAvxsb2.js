async function y(){try{if(typeof SETTINGS<"u"&&Array.isArray(SETTINGS.opTypes)){const e=$("#opTypeCode");e.html(""),SETTINGS.opTypes.forEach(n=>e.append(`<option value="${n.code}">${n.name}</option>`));return}}catch{}}function f(){$("#partnerId").select2({theme:"bootstrap-5",placeholder:"Rechercher un partenaire (code, nom, société)",allowClear:!0,ajax:{transport:function(e,n,t){$.ajax({url:`${API_BASEURL}/partners/fetch-by-term`,type:"GET",data:{term:e.data.term||""},success:n,error:t})},delay:250,processResults:function(e){return{results:(e||[]).map(t=>({id:t.id,text:`${t.code} - ${t.first_name} ${t.last_name}${t.company_name?" ("+t.company_name+")":""}`}))}}}})}function c(){$("#clientType").val()==="partner"?($("#partnerSelectBlock").show(),$("#manualClientBlock").hide()):($("#partnerSelectBlock").hide(),$("#manualClientBlock").show())}function u(e={label:"",qty:1,unit:0}){const n=$(`<tr>
      <td><input type="text" class="form-control item-label" placeholder="Désignation" value="${e.label}"></td>
      <td><input type="number" min="1" class="form-control item-qty" value="${e.qty}"></td>
      <td><input type="number" min="0" class="form-control item-unit" value="${e.unit}"></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="fas fa-trash"></i></button></td>
    </tr>`);n.find(".btn-del").on("click",()=>n.remove()),$("#itemsTable tbody").append(n)}function h(){const e=[];return $("#itemsTable tbody tr").each(function(){const n=$(this).find(".item-label").val()||"",t=parseFloat($(this).find(".item-qty").val()||"0"),a=parseFloat($(this).find(".item-unit").val()||"0");n&&t>0&&e.push({label:n,qty:t,unit:a})}),e}async function T(e){var n;e.preventDefault();try{swalLoading();const t=$("#opTypeCode").val(),a=$("#clientType").val(),o={client_type:a,amount:$("#amount").val(),items:h()};if(a==="partner"){const i=$("#partnerId").val();if(!i)return Swal.close(),Toast.fire("Sélectionnez un partenaire","","error");o.partner_id=i}else o.client_name=$("#client_name").val(),o.client_phone=$("#client_phone").val(),o.client_email=$("#client_email").val();const{data:r}=await ajax({url:`${API_BASEURL}/invoices/${t}/store`,type:"POST",data:o});Toast.fire(r.message||"Facture créée","","success"),location=`/invoices/${r.invoice.id}`}catch({error:t}){console.log(t),(n=t==null?void 0:t.responseJSON)!=null&&n.errors&&Swal.close(),showErrors(t.responseJSON||{message:"Erreur"})}}function v(){try{const e=new URLSearchParams(location.search),n=e.get("opTypeCode"),t=e.get("clientType"),a=e.get("partnerId"),o=e.get("partnerText"),r=e.get("amount"),i=e.get("items"),s=e.get("client_name"),p=e.get("client_phone"),m=e.get("client_email");if(n&&$("#opTypeCode").val(n),t&&$("#clientType").val(t),c(),t==="partner"&&a){const l=new Option(o||a,a,!0,!0);$("#partnerId").append(l).trigger("change")}if(t==="external"&&(s&&$("#client_name").val(s),p&&$("#client_phone").val(p),m&&$("#client_email").val(m)),r&&$("#amount").val(parseInt(r)),i)try{const l=JSON.parse(i);Array.isArray(l)&&($("#itemsTable tbody").html(""),l.forEach(d=>u(d)))}catch{}}catch(e){console.log(e)}}window.render=async function(){await y(),f(),$("#clientType").on("change",c),c(),v(),$("#addItemBtn").on("click",()=>u()),$("#form").on("submit",T)};
