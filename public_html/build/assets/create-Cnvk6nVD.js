async function x(){try{if(typeof SETTINGS<"u"&&Array.isArray(SETTINGS.opTypes)){const e=$("#opTypeCode");e.html(""),SETTINGS.opTypes.forEach(t=>e.append(`<option value="${t.code}">${t.name}</option>`));return}}catch{}}function _(){$("#partnerId").select2({theme:"bootstrap-5",placeholder:"Rechercher un partenaire (code, nom, sociÃ©tÃ©)",allowClear:!0,ajax:{transport:function(e,t,n){$.ajax({url:`${API_BASEURL}/partners/fetch-by-term`,type:"GET",data:{term:e.data.term||""},success:t,error:n})},delay:250,processResults:function(e){return{results:(e||[]).map(n=>({id:n.id,text:`${n.code} - ${n.first_name} ${n.last_name}${n.company_name?" ("+n.company_name+")":""}`}))}}}})}function p(){const e=$("#clientType").val();if(e==="partner")$("#partnerSelectBlock").show(),$("#extraClientSelectBlock").hide(),$("#manualClientBlock").hide(),$("#extraClientDetails").hide();else if(e==="extra_client"){$("#partnerSelectBlock").hide(),$("#extraClientSelectBlock").show(),$("#manualClientBlock").hide();const t=$("#extraClientId").val();t&&h(t)}else $("#partnerSelectBlock").hide(),$("#extraClientSelectBlock").hide(),$("#manualClientBlock").show(),$("#extraClientDetails").hide()}function f(e={label:"",qty:1,unit:0}){const t=$(`<tr>
      <td><input type="text" class="form-control item-label" placeholder="DÃ©signation" value="${e.label}"></td>
      <td><input type="number" min="1" class="form-control item-qty" value="${e.qty}"></td>
      <td><input type="number" min="0" class="form-control item-unit" value="${e.unit}"></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="fas fa-trash"></i></button></td>
    </tr>`);t.find(".btn-del").on("click",()=>t.remove()),$("#itemsTable tbody").append(t),window.LOCK_INVOICE_MODE&&(t.find(".item-label").prop("disabled",!0),t.find(".item-qty").prop("disabled",!0),t.find(".btn-del").prop("disabled",!0).hide())}function b(){const e=[];return $("#itemsTable tbody tr").each(function(){const t=$(this).find(".item-label").val()||"",n=parseFloat($(this).find(".item-qty").val()||"0"),a=parseFloat($(this).find(".item-unit").val()||"0");t&&n>0&&e.push({label:t,qty:n,unit:a})}),e}function C(e){try{$("#ecCompany").text(e.company_name||""),$("#ecTin").text(e.tin||""),$("#ecFullName").text(`${e.first_name||""} ${e.last_name||""}`.trim()),$("#ecPhone").text(e.phone_number||""),$("#ecEmail").text(e.email||""),$("#extraClientDetails").show()}catch(t){console.log(t)}}async function h(e){try{const{data:t}=await ajax({url:`${API_BASEURL}/extra-clients/fetch/${e}`,type:"GET"});C(t)}catch(t){console.log(t),$("#extraClientDetails").hide()}}async function T(e){var t;e.preventDefault();try{swalLoading();const n=$("#opTypeCode").val(),a=$("#clientType").val(),r={client_type:a==="extra_client"?"external":a,amount:$("#amount").val(),items:b()};if(a==="partner"){const l=$("#partnerId").val();if(!l)return Swal.close(),Toast.fire("SÃ©lectionnez un partenaire","","error");r.partner_id=l}else if(a==="extra_client"){const l=$("#extraClientId").val();if(!l)return Swal.close(),Toast.fire("SÃ©lectionnez un client extra","","error");try{const{data:i}=await ajax({url:`${API_BASEURL}/extra-clients/fetch/${l}`,type:"GET"});r.client_name=`${i.first_name||""} ${i.last_name||""}`.trim(),r.client_phone=i.phone_number||"",r.client_email=i.email||""}catch{return Swal.close(),Toast.fire("Impossible de charger le client extra","","error")}}else r.client_name=$("#client_name").val(),r.client_phone=$("#client_phone").val(),r.client_email=$("#client_email").val();const{data:c}=await ajax({url:`${API_BASEURL}/invoices/${n}/store`,type:"POST",data:r});Toast.fire(c.message||"Facture crÃ©Ã©e","","success"),location=`/invoices/${c.invoice.id}`}catch({error:n}){console.log(n),(t=n==null?void 0:n.responseJSON)!=null&&t.errors&&Swal.close(),showErrors(n.responseJSON||{message:"Erreur"})}}function g(){try{const e=new URLSearchParams(location.search),t=e.get("opTypeCode"),n=e.get("clientType"),a=e.get("partnerId"),r=e.get("partnerText"),c=e.get("amount"),l=e.get("items"),i=e.get("client_name"),d=e.get("client_phone"),m=e.get("client_email"),w=e.get("lock");if(t&&$("#opTypeCode").val(t),n&&$("#clientType").val(n),p(),n==="partner"&&a){const o=new Option(r||a,a,!0,!0);$("#partnerId").append(o).trigger("change")}if(n==="extra_client"){const o=e.get("extraClientId"),s=e.get("extraClientText");if(o){const y=new Option(s||o,o,!0,!0);$("#extraClientId").append(y).trigger("change")}}if(n==="external"&&(i&&$("#client_name").val(i),d&&$("#client_phone").val(d),m&&$("#client_email").val(m)),c&&$("#amount").val(parseInt(c)),l)try{const o=JSON.parse(l);Array.isArray(o)&&($("#itemsTable tbody").html(""),o.forEach(s=>f(s)))}catch{}}catch(e){console.log(e)}}function I(){new URLSearchParams(location.search).get("lock")&&(window.LOCK_INVOICE_MODE=!0,$("#opTypeCode").prop("disabled",!0),$("#clientType").prop("disabled",!0),$("#partnerId").prop("disabled",!0),$("#manualClientBlock :input").prop("disabled",!0),$("#manualClientBlock").hide(),$("#itemsTable tbody tr").each(function(){$(this).find(".item-label").prop("disabled",!0),$(this).find(".item-qty").prop("disabled",!0),$(this).find(".btn-del").prop("disabled",!0).hide()}))}window.render=async function(){await x(),_(),S(),typeof u=="function"&&u(),$("#clientType").on("change",p),p(),g(),I(),$("#extraClientId").one("select2:open",async function(){try{const e=await $.ajax({url:`${API_BASEURL}/extra-clients/fetch-all`,type:"GET"}),t=$("#extraClientId");(e||[]).forEach(n=>{if(t.find(`option[value='${n.id}']`).length===0){const a=`${n.first_name||""} ${n.last_name||""}${n.company_name?" ("+n.company_name+")":""} - ${n.phone_number||""}`.trim(),r=new Option(a,n.id,!1,!1);t.append(r)}})}catch(e){console.log(e)}}).on("change",function(){if($("#clientType").val()==="extra_client"){const e=$(this).val();e?h(e):$("#extraClientDetails").hide()}}),$("#addItemBtn").on("click",()=>f()),$("#form").on("submit",T)};function u(){try{$("#extraClientId").data("select2")&&$("#extraClientId").select2("destroy")}catch{}$("#extraClientId").select2({theme:"bootstrap-5",placeholder:"Sélectionner un client extra",allowClear:!0,minimumInputLength:0,ajax:{transport:function(e,t,n){const a=e.data&&e.data.term||"";a?$.ajax({url:`${API_BASEURL}/extra-clients/list`,type:"POST",data:{draw:1,start:0,length:100,search:{value:a}},success:t,error:n}):$.ajax({url:`${API_BASEURL}/extra-clients/fetch-all`,type:"GET",success:t,error:n})},delay:200,processResults:function(e){return{results:(Array.isArray(e)?e:e&&e.data?e.data:[]).map(a=>({id:a.id,text:`${a.first_name||""} ${a.last_name||""}${a.company_name?" ("+a.company_name+")":""} - ${a.phone_number||""}`.trim()}))}}}})}function S(){$("#extraClientId").select2({theme:"bootstrap-5",placeholder:"Rechercher un client extra (nom, téléphone, société)",allowClear:!0,ajax:{transport:function(e,t,n){$.ajax({url:`${API_BASEURL}/extra-clients/list`,type:"POST",data:{draw:1,start:0,length:10,search:{value:e.data.term||""}},success:t,error:n})},delay:250,processResults:function(e){return{results:(e&&e.data?e.data:[]).map(a=>({id:a.id,text:`${a.first_name||""} ${a.last_name||""}${a.company_name?" ("+a.company_name+")":""} - ${a.phone_number||""}`.trim()}))}}}})}
