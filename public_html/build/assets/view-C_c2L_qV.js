let a=null;async function y(){var s;const t=$("#objectId").val();if(t)try{const{data:n}=await ajax({url:`${API_BASEURL}/collabs/fetch/${t}`,type:"GET"});a=n}catch({error:n}){await Swal.fire(((s=n.responseJSON)==null?void 0:s.message)||"Erreur lors de la récupération","","error"),location="/collabs"}}function j(){$("#code").html(a.code),$("#firstName").html(a.first_name),$("#lastName").html(a.last_name),$("#phoneNumber").html(a.phone_number),$("#email").html(a.email),$("#picture").html(`<img src="${getUploadUrl(a.picture)}" width="360">`),$("#status").html(a.status==="enabled"?'<span class="badge rounded-pill bg-success">Actif</span>':'<span class="badge rounded-pill bg-secondary">Inactif</span>')}async function w(t){var s;try{if(!(await Swal.fire({title:`Voulez-vous vraiment ${t==="enabled"?"activer":"désactiver"} le collaborateur ${a.code}?`,text:"Cette opération est irréversible",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"})).isConfirmed)throw{};swalLoading();const{data:c}=await ajax({url:`${API_BASEURL}/collabs/change-status/${a.id}`,type:"POST",data:{status:t}});Toast.fire(c.message,"","success"),location.reload()}catch({error:n}){Swal.fire(((s=n.responseJSON)==null?void 0:s.message)||"Erreur","","error")}}async function O(){var t;try{if(!(await Swal.fire({title:`Voulez-vous vraiment supprimer le collaborateur ${a.code}?`,text:"Cette opération est irréversible",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"})).isConfirmed)throw{};swalLoading();const{data:n}=await ajax({url:`${API_BASEURL}/collabs/delete/${a.id}`,type:"POST"});Toast.fire(n.message,"","success"),location="/collabs"}catch({error:s}){Swal.fire(((t=s.responseJSON)==null?void 0:t.message)||"Erreur","","error")}}window.render=async function(){await y(),setTitle(`Details du collaborateur ${a.code} (${a.first_name} ${a.last_name})`),j(),$("#enable").click(async()=>await w("enabled")),$("#disable").click(async()=>await w("disabled")),$("#delete").click(async()=>await O()),a.status!=="disabled"&&$("#enable").hide(),a.status!=="enabled"&&$("#disable").hide();const t=$("#collabBalance"),s=$("#collabCurrency");function n(){return a&&typeof a.user_id<"u"&&a.user_id?a.user_id:a.id}async function c(){try{const l=await $.get(`${API_BASEURL}/admin/collabs/${n()}/balance`);l!=null&&l.ok&&(t.text(l.balance),s.text(l.currency||""))}catch(l){console.error("Erreur refreshBalance:",l)}}$("#btnOpenAdjust").on("click",()=>$("#modalAdjustBalance").modal("show")),$("#formAdjustBalance").on("submit",async function(l){var u,d,m,f,b;l.preventDefault();const r=$(this),p=r.find('[name="amount"]').val(),h=String(p||"").replace(/\s+/g,"").replace(/,/g,"").replace(/\./g,""),S=parseInt(h,10)||0,i={direction:r.find('[name="direction"]').val(),amount:S,reason:r.find('[name="reason"]').val()};try{Swal.fire({title:"Traitement...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const e=$('meta[name="csrf-token"]').attr("content")||"";console.log("[adjust] POST /api/v1/admin/collabs/"+a.id+"/balance/adjust",i,"csrf?",!!e);const{data:o}=await ajax({url:`${API_BASEURL}/admin/collabs/${a.id}/balance/adjust`,type:"POST",data:i,headers:{"X-CSRF-TOKEN":e}});Swal.close(),o!=null&&o.ok?(await Swal.fire(o.message||"Solde mis à jour.","","success"),$("#modalAdjustBalance").modal("hide"),c()):await Swal.fire((o==null?void 0:o.message)||"Erreur.","","error")}catch(e){Swal.close();const o=(e==null?void 0:e.status)||((u=e==null?void 0:e.error)==null?void 0:u.status)||"???",g=((d=e==null?void 0:e.responseJSON)==null?void 0:d.message)||((f=(m=e==null?void 0:e.error)==null?void 0:m.responseJSON)==null?void 0:f.message)||(e==null?void 0:e.responseText)||((b=e==null?void 0:e.error)==null?void 0:b.responseText)||(e==null?void 0:e.message)||"Erreur.";console.error("Erreur adjust balance:",{status:o,err:e}),Swal.fire(`Erreur (${o})`,g,"error")}}),c()};
