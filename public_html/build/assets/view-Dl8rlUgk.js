let e=null,a=null;function d(){const o=$("#opTypeCode").val();a=SETTINGS&&Array.isArray(SETTINGS.opTypes)?SETTINGS.opTypes.find(t=>t.code===o):null}async function p(){var t;const o=$("#objectId").val();if(!(!o||!a))try{const{data:s}=await ajax({url:`${API_BASEURL}/operations/${a.code}/fetch/${o}`,type:"GET"});e=s}catch({error:s}){await Swal.fire(((t=s==null?void 0:s.responseJSON)==null?void 0:t.message)||"Erreur","","error"),location=`/operations/${(a==null?void 0:a.code)||""}`}}function m(){var t,s,i,u;if(!e||!a)return;if(["account_recharge","balance_withdrawal"].includes(a.code))$("#blockCommissions").hide();else{const r=parseInt(e.amount||0),c=parseInt(e.fee||0),n=parseInt(e.commission||0);$("#amount").html(formatAmount(r)),$("#fee").html(formatAmount(c)),$("#totalAmount").html(formatAmount(r+c)),$("#commission").html(formatAmount(n)),$("#commissionPlatform").html(formatAmount(c>n?c-n:0))}switch((t=e.partner)!=null&&t.user&&($("#codePartner").html(e.partner.user.code||""),$("#firstName").html(e.partner.user.first_name||""),$("#lastName").html(e.partner.user.last_name||"")),e.company&&($("#companyName").html(e.company.name||""),$("#tin").html(e.company.tin||"")),e.status){case"pending":$("#status").html('<span class="badge bg-secondary">En attente</span>');break;case"approved":$("#status").html('<span class="badge bg-success">Validée</span>');break;case"rejected":$("#status").html('<span class="badge bg-danger">Rejetée</span>');break}$("#reviewer").html(e.status==="pending"?"":`${((s=e.reviewer)==null?void 0:s.first_name)||""} ${((i=e.reviewer)==null?void 0:i.last_name)||""}`),$("#reviewedAt").html(e.status==="pending"?"":e.reviewed_at||""),$("#feedback").html(e.feedback||"");const o=$("#tableOperation tbody");o.html("");for(const[r,c]of a.sorted_fields||[]){if(r===a.amount_field)continue;let n="";const l=e.data?e.data[r]:null;if(l!=null)switch(c.type){case"number":n=c.is_amount?formatAmount(l):l;break;case"file":n=`<a class="btn btn-outline-primary" target="_blank" href="${getUploadUrl(l)}"><i class="fas fa-eye"></i></a>`;break;case"country":n=`<img src="${getCountryFlagUrl(e.countries[r].code)}"> ${e.countries[r].name}`;break;default:n=l}a.code==="card_recharge"&&["client_first_name","client_last_name"].includes(r)&&(n=`<span class="fw-bold text-danger">${n}</span>`),o.append(`<tr><th>${c.label}</th><td>${n}</td></tr>`)}(u=USER==null?void 0:USER.hasRole)!=null&&u.call(USER,"reviewer")&&a.code==="card_activation"&&e.duplicates&&$("#alertMessage").html(`Ce client a déjà fait l'objet ${e.duplicates===1?"d'une autre activation de carte approuvée":`de ${e.duplicates} autres activations de cartes approuvées`}`).show()}async function f(){var o;try{const t=await Swal.fire({title:`Voulez-vous vraiment valider l'opération ${a.name} ${e.code}?`,text:"Cette opération est irréversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();const{data:s}=await ajax({url:`${API_BASEURL}/operations/${a.code}/approve/${e.id}`,type:"POST",data:{feedback:t.value,without_commission:!1}});Toast.fire(s.message,"","success"),location.reload()}catch({error:t}){Swal.fire(((o=t==null?void 0:t.responseJSON)==null?void 0:o.message)||"Erreur","","error")}}async function h(){var o;try{const t=await Swal.fire({title:`Voulez-vous vraiment valider l'opération ${a.name} ${e.code} sans les commissions?`,text:"Cette opération est irréversible. Et le partenaire ne recevra pas de commissions.",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();const{data:s}=await ajax({url:`${API_BASEURL}/operations/${a.code}/approve/${e.id}`,type:"POST",data:{feedback:t.value,without_commission:!0}});Toast.fire(s.message,"","success"),location.reload()}catch({error:t}){Swal.fire(((o=t==null?void 0:t.responseJSON)==null?void 0:o.message)||"Erreur","","error")}}async function w(){var o;try{const t=await Swal.fire({title:`Voulez-vous vraiment rejeter l'opération ${a.name} ${e.code}?`,text:"Cette opération est irréversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();const{data:s}=await ajax({url:`${API_BASEURL}/operations/${a.code}/reject/${e.id}`,type:"POST",data:{feedback:t.value}});Toast.fire(s.message,"","success"),location.reload()}catch({error:t}){Swal.fire(((o=t==null?void 0:t.responseJSON)==null?void 0:o.message)||"Erreur","","error")}}async function b(){var o;try{if(!(await Swal.fire({title:`Voulez-vous vraiment supprimer l'opération ${a.name} ${e.code}?`,text:"Cette opération est irréversible",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"})).isConfirmed)throw{};swalLoading();const{data:s}=await ajax({url:`${API_BASEURL}/operations/${a.code}/delete/${e.id}`,type:"POST"});Toast.fire(s.message,"","success"),location=`/operations/${a.code}`}catch({error:t}){Swal.fire(((o=t==null?void 0:t.responseJSON)==null?void 0:o.message)||"Erreur","","error")}}function v(){const o=typeof(USER==null?void 0:USER.hasRole)=="function"&&USER.hasRole("collab"),t=!!e&&e.status==="approved",s=$(".card-header h4").filter(function(){return $(this).text().trim()==="Actions"}).closest(".card").find(".card-body").first();if(!(!o||!t||!s.length)&&!$("#btnCancelOp").length){const i=$(`<button type="button" class="btn btn-lg btn-outline-danger ms-2" id="btnCancelOp"><i class="fas fa-undo me-2"></i> Demander l'annulation</button>`);s.append(i),$("#btnCancelOp").on("click",async function(){var c;const u=$('meta[name="csrf-token"]').attr("content")||"",{value:r}=await Swal.fire({title:"Demander l'annulation",input:"textarea",inputPlaceholder:"Motif (obligatoire)",showCancelButton:!0,confirmButtonText:"Envoyer",cancelButtonText:"Annuler",preConfirm:n=>((!n||!n.trim())&&Swal.showValidationMessage("Le motif est requis"),n)});if(r){Swal.fire({title:"Envoi en cours...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{const n=await $.ajax({url:`${API_BASEURL}/operations-cancel/request/${e.id}`,method:"POST",dataType:"json",data:{reason:r},headers:{"X-CSRF-TOKEN":u,"X-Requested-With":"XMLHttpRequest"}});Swal.fire(n.message||"Demande envoyée.","","success"),$("#btnCancelOp").prop("disabled",!0)}catch(n){const l=((c=n==null?void 0:n.responseJSON)==null?void 0:c.message)||(n==null?void 0:n.responseText)||(n==null?void 0:n.message)||"Erreur";Swal.fire(l,"","error")}}})}}window.render=async function(){d(),await p(),setTitle(`${a.name} ${e.code}`),$("#linkList").html('<i class="fas fa-list"></i> Liste des opérations').attr("href",`/operations/${a.code}`),m(),v(),e&&e.status==="approved"?$("#createInvoice").show().off("click").on("click",function(){var o;try{const t=e.partner&&e.partner.id?e.partner.id:e.partner_id;if(!t)throw new Error("Partenaire introuvable");const s=e.partner&&e.partner.user?`${e.partner.user.code} - ${e.partner.user.first_name} ${e.partner.user.last_name}${(o=e.company)!=null&&o.name?" ("+e.company.name+")":""}`:`${t}`,i=new URLSearchParams;i.set("opTypeCode",a.code),i.set("clientType","partner"),i.set("partnerId",String(t)),i.set("partnerText",s),i.set("lock","1");const u=[{label:a.name||"Opération",qty:1,unit:0}];i.set("items",JSON.stringify(u)),location=`/invoices/create?${i.toString()}`}catch(t){const s=(t==null?void 0:t.message)||"Impossible d’ouvrir la création de facture";typeof Swal<"u"?Swal.fire(s,"","error"):alert(s)}}):$("#createInvoice").hide(),$("#edit").click(()=>location=`/operations/${a.code}/${e.id}/edit`),$("#approve").click(f),$("#approveWithoutCommission").click(h),$("#reject").click(w),$("#delete").click(b),e.status!=="rejected"&&$("#edit").hide(),e.status!=="pending"&&($("#approve").hide(),$("#reject").hide()),(e.status!=="pending"||["account_recharge","balance_withdrawal"].includes(a.code)||!hasCommissions(e.master,a.id,e.data.card_type||null)&&a.code!=="card_activation")&&$("#approveWithoutCommission").hide()};
