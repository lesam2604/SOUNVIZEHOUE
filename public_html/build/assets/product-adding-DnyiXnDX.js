window.datatableProducts=null;window.selectedProduct=null;window.selectedProductRow=null;window.populateProductAdding=async function(e=null){try{e||(e=(await ajax({url:`${API_BASEURL}/inv-products/fetch-all`,type:"GET"})).data),$("#invProductId").empty();for(const t of e)$("#invProductId").append(`<option value="${t.id}" data-code="${t.code}"
        data-category="${t.category.name}" data-unit_price="${t.unit_price}">${t.name}</option>`)}catch({error:t}){await Swal.fire(t.responseJSON.message,"","error")}};window.clearProductAdding=function(){$("#invProductId").val("").prop("disabled",!1),$("#quantity").val("0"),datatableProducts.clear().draw()};window.setProductAdding=function(e){$("#invProductId").val("").change(),$("#quantity").val(""),datatableProducts.clear();for(const t of e)datatableProducts.row.add({product_id:t.id,code:t.code,name:t.name,category_name:t.category.name,unit_price:t.pivot.unit_price,quantity:t.pivot.quantity,total_cost:t.pivot.unit_price*t.pivot.quantity});datatableProducts.draw()};window.fillProductAdding=function(e){return e.products=JSON.stringify(datatableProducts.rows().data().toArray().map(t=>({id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))),e};window.initDataTableProducts=function(){datatableProducts=$("#tableProducts").on("click",".edit",async function(e){selectedProductRow=$(this).closest("tr"),selectedProduct=datatableProducts.row(selectedProductRow).data();const{value:t}=await Swal.fire({title:`Modifier ${selectedProduct.name}`,html:`<div class="mb-2 text-start"><label class="form-label">Prix unitaire</label><input type="number" id="swalUnitPrice" class="form-control" value="${selectedProduct.unit_price}"></div><div class="mb-2 text-start"><label class="form-label">Quantité</label><input type="number" id="swalQuantity" class="form-control" value="${selectedProduct.quantity}"></div>`,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Enregistrer",cancelButtonText:"Annuler",preConfirm:()=>({unit_price:parseFloat(document.getElementById("swalUnitPrice").value)||0,quantity:parseInt(document.getElementById("swalQuantity").value)||0})});t&&(selectedProduct.unit_price=t.unit_price>0?t.unit_price:selectedProduct.unit_price,selectedProduct.quantity=t.quantity>0?t.quantity:selectedProduct.quantity,selectedProduct.total_cost=selectedProduct.unit_price*selectedProduct.quantity,datatableProducts.row(selectedProductRow).data(selectedProduct).draw(!1),selectedProductRow=null,selectedProduct=null)}).on("click",".remove",function(e){datatableProducts.row($(this).closest("tr")).remove().draw(!1)}).DataTable({columns:[{data:"code"},{data:"name"},{data:"category_name"},{data:"unit_price",render:(e,t,a)=>formatAmount(e)},{data:"quantity"},{data:"total_cost",render:(e,t,a)=>formatAmount(e)},{orderable:!1,render:(e,t,a)=>`
              <div class="d-flex">
                <button type="button" class="btn btn-sm btn-primary m-1 edit"><i class="fas fa-edit"></i> Éditer</button>
                <button type="button" class="btn btn-sm btn-danger m-1 remove"><i class="fas fa-minus"></i> Retirer</button>
              </div>
            `}],order:[0,"desc"],pageLength:-1,autoWidth:!1}),$("#tableProducts").wrap('<div style="overflow-x: auto;"></div>')};window.initProductAdding=function(){initDataTableProducts(),$("#addProduct").click(function(e){let t=$("#invProductId").find("option:selected"),a=parseInt(t.attr("value")),r=parseInt($("#quantity").val());if(selectedProduct===null){if(!a){Swal.fire("Veuillez sélectionner un produit","","error");return}if(datatableProducts.rows().data().filter(i=>i.product_id===a).length>0){Swal.fire("Ce produit figure déjà sur la liste","","error");return}if(r<=0){Swal.fire("La quantité n'est pas valide","","error");return}let d=parseFloat($("#unitPrice").val());d>0||(d=parseFloat(t.data("unit_price"))),datatableProducts.row.add({product_id:a,code:t.data("code"),name:t.text(),category_name:t.data("category"),unit_price:d,quantity:r,total_cost:d*r})}else{let o=selectedProduct.unit_price*r;selectedProduct.quantity=r,selectedProduct.total_cost=o,datatableProducts.row(selectedProductRow).data(selectedProduct),selectedProductRow=null,selectedProduct=null}datatableProducts.draw(!1),$("#invProductId").val("").prop("disabled",!1),$("#quantity").val("0"),$("#unitPrice").val("")})};
