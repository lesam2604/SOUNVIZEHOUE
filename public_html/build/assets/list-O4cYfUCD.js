let n=null;function u(){const r=document.querySelector('meta[name="csrf-token"]');return r?r.getAttribute("content"):""}function p(){return typeof API_BASEURL<"u"&&API_BASEURL?API_BASEURL:""}function f(){const r=$("#opTypeCode").val();n=SETTINGS.opTypes.find(s=>s.code===r)}async function m(r){var s,d;swalLoading();try{await downloadFile(`${p()}/operations/card-activation-export-pdf`,"GET",{operation_id:r.id}),Swal.close()}catch(e){console.error(e);const t=((d=(s=e==null?void 0:e.error)==null?void 0:s.responseJSON)==null?void 0:d.message)||"Erreur export PDF";Swal.fire(t,"","error")}}function _(){console.log("[list.js] initDataTable()");const r=$("#table thead"),s=$(`
    <tr>
      <th>#</th>
      <th>Code</th>
      <th>Statut</th>
    </tr>
  `).appendTo(r),d=[{data:"__no__",name:"created_at"},{data:"code",name:"code",render:(e,t,a)=>`<a href="/operations/${n.code}/${a.id}">${e}</a>`},{data:"status",name:"status",render:e=>{const t=String(e??"");return t.includes("<")?t:t==="pending"||t.toLowerCase()==="en attente"?'<span class="badge bg-secondary">En attente</span>':t==="approved"||t.toLowerCase()==="validée"||t.toLowerCase()==="validee"?'<span class="badge bg-success">Validée</span>':t==="rejected"||t.toLowerCase()==="rejetée"||t.toLowerCase()==="rejetee"?'<span class="badge bg-danger">Rejetée</span>':t}}];for(const[e,t]of n.sorted_fields)t.listed&&(n.code==="account_recharge"&&e==="trans_amount"&&(s.append("<th>Montant avant prélèvement</th><th>Frais (MomoPay)</th>"),d.push({data:a=>a.data.sender_phone_number_type==="MomoPay"?a.data.trans_amount/(1-.005):a.data.trans_amount,searchable:!1,orderable:!1,render:a=>formatAmount(a)},{data:a=>a.data.sender_phone_number_type==="MomoPay"?a.data.trans_amount*.005/(1-.005):0,searchable:!1,orderable:!1,render:a=>formatAmount(a)})),s.append(`<th>${e===n.amount_field?"Montant":t.label}</th>`),d.push({data:a=>{var o;return((o=a.data)==null?void 0:o[e])??""},searchable:!1,orderable:!1,render:a=>t.is_amount?formatAmount(a):a}));s.append("<th>Opérateur</th><th>Effectuée le</th>"),d.push({data:"partner",name:"partner",render:(e,t,a)=>USER.partner&&USER.partner.id===a.partner_id?`${e} (${a.partner_code})`:`${e} (<a href="/partners/${a.partner_id}">${a.partner_code}</a>)`},{data:"created_at",name:"created_at"}),s.append("<th>Actions</th>"),d.push({data:null,name:"actions",orderable:!1,searchable:!1,render:(e,t,a)=>{const o=(a.__status_plain||"").toLowerCase(),i=o==="approved"||o==="validée"||o==="validee",l=typeof(USER==null?void 0:USER.hasRole)=="function"&&USER.hasRole("collab");return i&&l?`
          <button class="btn btn-sm btn-outline-danger js-cancel-request" data-id="${a.id}">
            <i class="fas fa-undo me-1"></i> Annuler
          </button>
        `:""}}),window.datatable=$("#table").on("click",".export-card",function(){const e=window.datatable.row($(this).closest("tr")).data();m(e)}).on("click",".js-cancel-request",async function(){var a,o,i;const e=$(this).data("id");if((await Swal.fire({title:"Confirmer la demande ?",text:"Cette demande sera envoyée à l'administrateur.",icon:"warning",showCancelButton:!0,confirmButtonText:"Oui, envoyer",cancelButtonText:"Annuler"})).isConfirmed)try{swalLoading("Envoi de la demande...");const l={"X-CSRF-TOKEN":u()},c=await axios.post(`${p()}/collab/operations-cancel`,{operation_id:e},{headers:l});Swal.fire(((a=c==null?void 0:c.data)==null?void 0:a.message)||"Demande envoyée.","","success")}catch(l){console.error(l);const c=((i=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:i.message)||"Erreur pendant l’envoi.";Swal.fire(c,"","error")}}).DataTable({processing:!0,serverSide:!0,columns:d,order:[0,"desc"],ajax:{url:`${p()}/operations/${n.code}/list`,type:"POST",dataType:"json",data:e=>{e.operation_type_id=n.id,e.partner_id=$("#partnerId").val(),e.from_date=$("#fromDate").val(),e.to_date=$("#toDate").val(),e.status=$("#status").val(),e.card_type=$("#cardType").val()??"",e.uba_type=$("#ubaType").val()??"",["card_activation","card_recharge","card_deactivation"].includes(n.code)&&e.columns.push({data:"card_id",name:"card_id",searchable:!0,orderable:!1}),["canal_activation","canal_resub"].includes(n.code)&&e.columns.push({data:"decoder_number",name:"decoder_number",searchable:!0,orderable:!1})},error:e=>{var t;Swal.fire(((t=e==null?void 0:e.responseJSON)==null?void 0:t.message)||"Erreur chargement liste","","error")},dataSrc:e=>{const t=((e==null?void 0:e.data)||[]).map(a=>{try{a.data=JSON.parse(a.data)}catch{}const i=String(a.status??"").replace(/<[^>]+>/g,"").trim();return a.__status_plain=i.toLowerCase(),a});return console.log("[list.js] dataSrc rows:",t.length),t}},pageLength:25,autoWidth:!1,deferLoading:0}),$("#table").wrap('<div style="overflow-x: auto;"></div>'),console.log("[list.js] DataTable ready -> typeof window.datatable =",typeof window.datatable)}async function h(){setTitle(`Liste des opérations «${n.name}»`),USER.hasRole("partner-pos")&&["balance_withdrawal"].includes(n.code)?$("#linkCreate").hide():$("#linkCreate").html('<i class="fas fa-plus"></i> Ajouter une nouvelle opération').attr("href",`/operations/${n.code}/create`),$("#exportExcel").click(async function(r){r.preventDefault(),swalLoading(),await downloadFile(`${p()}/operations/${n.code}/export-excel`,"GET",{partner_id:$("#partnerId").val()??"",from_date:$("#fromDate").val(),to_date:$("#toDate").val(),status:$("#status").val(),card_type:$("#cardType").val(),uba_type:$("#ubaType").val()}),Swal.close()}),$("#exportPdf").click(async function(r){r.preventDefault(),swalLoading(),await downloadFile(`${p()}/operations/${n.code}/export-pdf`,"GET",{partner_id:$("#partnerId").val()??"",from_date:$("#fromDate").val(),to_date:$("#toDate").val(),status:$("#status").val(),card_type:$("#cardType").val(),uba_type:$("#ubaType").val()}),Swal.close()}),$("#status, #partnerId, #fromDate, #toDate, #cardType, #ubaType").change(function(){window.datatable&&window.datatable.draw()}),$("#status").val($("#opStatus").val()).change(),USER.hasRole("partner")?$("#partnerId").parent().removeClass("d-flex").addClass("d-none"):populatePartners("#partnerId"),["card_activation","card_recharge","card_deactivation"].includes(n.code)?populateCardTypes("#cardType"):$("#cardType").parent().removeClass("d-flex").addClass("d-none"),USER.hasRole("partner")||n.code!=="card_activation"?$("#ubaType").parent().removeClass("d-flex").addClass("d-none"):populateUbaTypes("#ubaType")}window.render=async function(){console.log("[list.js] render()"),f(),_(),await h()};(function(){console.log("[list.js] loaded, autoBoot()"),document.readyState!=="loading"?window.render():document.addEventListener("DOMContentLoaded",()=>window.render(),{once:!0})})();
