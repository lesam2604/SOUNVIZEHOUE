let e=null,o=null;function p(){const a=$("#opTypeCode").val();o=SETTINGS.opTypes.find(t=>t.code===a)}async function f(){const a=$("#objectId").val();if(a)try{const{data:t}=await ajax({url:`${API_BASEURL}/operations/${o.code}/fetch/${a}`,type:"GET"});e=t}catch({error:t}){await Swal.fire(t.responseJSON.message,"","error"),location=`/operations/${o.code}`}}function h(){if(["account_recharge","balance_withdrawal"].includes(o.code))$("#blockCommissions").hide();else{let t=parseInt(e.amount),i=parseInt(e.fee),n=parseInt(e.commission);$("#amount").html(formatAmount(t)),$("#fee").html(formatAmount(i)),$("#totalAmount").html(formatAmount(t+i)),$("#commission").html(formatAmount(n)),$("#commissionPlatform").html(formatAmount(i>n?i-n:0))}switch($("#codePartner").html(e.partner.user.code),$("#firstName").html(e.partner.user.first_name),$("#lastName").html(e.partner.user.last_name),$("#companyName").html(e.company.name),$("#tin").html(e.company.tin),e.status){case"pending":$("#status").html('<span class="badge bg-secondary">En attente</span>');break;case"approved":$("#status").html('<span class="badge bg-success">ValidÃ©e</span>');break;case"rejected":$("#status").html('<span class="badge bg-danger">RejetÃ©e</span>');break}$("#reviewer").html(e.status==="pending"?"":`${e.reviewer.first_name} ${e.reviewer.last_name}`),$("#reviewedAt").html(e.status==="pending"?"":e.reviewed_at),$("#feedback").html(e.feedback?e.feedback:"");const a=$("#tableOperation tbody");for(const[t,i]of o.sorted_fields){if(t===o.amount_field)continue;let n=null;if((e.data[t]??null)===null)n="";else switch(i.type){case"select":case"text":case"textarea":case"email":case"date":case"datetime":n=e.data[t];break;case"number":n=i.is_amount?formatAmount(e.data[t]):e.data[t];break;case"file":n=`<a class="btn btn-outline-primary" target="_blank" href="${getUploadUrl(e.data[t])}"><i class="fas fa-eye"></i><a>`;break;case"card":n=e.data[t];break;case"country":n=`<img src="${getCountryFlagUrl(e.countries[t].code)}"> ${e.countries[t].name}`;break}o.code==="account_recharge"&&t==="trans_amount"&&a.append(`
        <tr>
          <th>Montant avant prÃ©lÃ¨vement</th>
          <td>${formatAmount(e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount/(1-.005):e.data.trans_amount)}</td>
        </tr>
        <tr>
          <th>Frais (MomoPay)</th>
          <td>${formatAmount(e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount*.005/(1-.005):0)}</td>
        </tr>
      `),o.code==="card_recharge"&&["client_first_name","client_last_name"].includes(t)&&(n=`<span class="fw-bold text-danger">${n}</span>`),a.append(`
      <tr>
        <th>${i.label}</th>
        <td>${n}</td>
      </tr>
    `)}USER.hasRole("reviewer")&&o.code==="card_activation"&&e.duplicates&&$("#alertMessage").html(`Ce client a dÃ©jÃ  fait l'object ${e.duplicates===1?"d'une autre activation de carte approuvÃ©e":`de ${e.duplicates} autres activations de cartes approuvÃ©es`}`).show()}async function w(){try{let a=await Swal.fire({title:`Voulez-vous vraiment valider l'opÃ©ration ${o.name} ${e.code}?`,text:"Cette opÃ©ration est irreversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!a.isConfirmed)throw{};swalLoading();let{data:t}=await ajax({url:`${API_BASEURL}/operations/${o.code}/approve/${e.id}`,type:"POST",data:{feedback:a.value,without_commission:!1}});Toast.fire(t.message,"","success"),location.reload()}catch({error:a}){Swal.fire(a.responseJSON.message,"","error")}}async function b(){try{let a=await Swal.fire({title:`Voulez-vous vraiment valider l'opÃ©ration ${o.name} ${e.code} sans les commissions?`,text:"Cette opÃ©ration est irreversible. Et le partenaire ne recevra pas de commissions.",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!a.isConfirmed)throw{};swalLoading();let{data:t}=await ajax({url:`${API_BASEURL}/operations/${o.code}/approve/${e.id}`,type:"POST",data:{feedback:a.value,without_commission:!0}});Toast.fire(t.message,"","success"),location.reload()}catch({error:a}){Swal.fire(a.responseJSON.message,"","error")}}async function l(){try{let a=await Swal.fire({title:`Voulez-vous vraiment rejeter l'opÃ©ration ${o.name} ${e.code}?`,text:"Cette opÃ©ration est irreversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!a.isConfirmed)throw{};swalLoading();let{data:t}=await ajax({url:`${API_BASEURL}/operations/${o.code}/reject/${e.id}`,type:"POST",data:{feedback:a.value}});Toast.fire(t.message,"","success"),location.reload()}catch({error:a}){Swal.fire(a.responseJSON.message,"","error")}}async function d(){try{if(!(await Swal.fire({title:`Voulez-vous vraiment supprimer l'opÃ©ration ${o.name} ${e.code}?`,text:"Cette opÃ©ration est irreversible",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"})).isConfirmed)throw{};swalLoading();let{data:t}=await ajax({url:`${API_BASEURL}/operations/${o.code}/delete/${e.id}`,type:"POST"});Toast.fire(t.message,"","success"),location=`/operations/${o.code}`}catch({error:a}){Swal.fire(a.responseJSON.message,"","error")}}function v(){const a=typeof(USER==null?void 0:USER.hasRole)=="function"&&USER.hasRole("collab"),t=!!e&&e.status==="approved",i=$(".card-header h4").filter(function(){return $(this).text().trim()==="Actions"}).closest(".card").find(".card-body").first();if(!(!a||!t||!i.length)&&!$("#btnCancelOp").length){const n=$(`
      <button type="button" class="btn btn-lg btn-outline-danger ms-2" id="btnCancelOp">
        <i class="fas fa-undo me-2"></i> Demander l'annulation
      </button>
    `);i.append(n),$("#btnCancelOp").on("click",async function(){var c;const u=$('meta[name="csrf-token"]').attr("content")||"",{value:r}=await Swal.fire({title:"Demander l'annulation",input:"textarea",inputPlaceholder:"Motif (obligatoire)",inputAttributes:{"aria-label":"Motif"},showCancelButton:!0,confirmButtonText:"Envoyer",cancelButtonText:"Annuler",preConfirm:s=>((!s||!s.trim())&&Swal.showValidationMessage("Le motif est requis"),s)});if(r){Swal.fire({title:"Envoi en cours...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{const s=await $.ajax({url:`${API_BASEURL}/operations-cancel/request/${e.id}`,method:"POST",dataType:"json",data:{reason:r},headers:{"X-CSRF-TOKEN":u,"X-Requested-With":"XMLHttpRequest"}});Swal.fire(s.message||"Demande envoyÃ©e.","","success"),$("#btnCancelOp").prop("disabled",!0)}catch(s){const m=((c=s==null?void 0:s.responseJSON)==null?void 0:c.message)||(s==null?void 0:s.responseText)||(s==null?void 0:s.message)||"Erreur";Swal.fire(m,"","error")}}})}}window.render=async function(){p(),await f(),setTitle(`${o.name} ${e.code}`),$("#linkList").html('<i class="fas fa-list"></i> Liste des opÃ©rations').attr("href",`/operations/${o.code}`),h(),v(),$("#edit").click(()=>location=`/operations/${o.code}/${e.id}/edit`),$("#approve").click(w),$("#approveWithoutCommission").click(b),$("#reject").click(l),$("#delete").click(d),e.status!=="rejected"&&$("#edit").hide(),e.status!=="pending"&&($("#approve").hide(),$("#reject").hide()),(e.status!=="pending"||["account_recharge","balance_withdrawal"].includes(o.code)||!hasCommissions(e.master,o.id,e.data.card_type||null)&&o.code!=="card_activation")&&$("#approveWithoutCommission").hide()};$("#reject").click(function(){l()});$("#delete").click(function(){d()});e.status!=="rejected"&&$("#edit").hide();e.status!=="pending"&&($("#approve").hide(),$("#reject").hide());(e.status!=="pending"||["account_recharge","balance_withdrawal"].includes(o.code)||!hasCommissions(e.master,o.id,e.data.card_type||null)&&o.code!=="card_activation")&&$("#approveWithoutCommission").hide();
