let n=null;function f(){const o=document.querySelector('meta[name="csrf-token"]');return o?o.getAttribute("content"):""}function u(){return typeof API_BASEURL<"u"&&API_BASEURL?API_BASEURL:""}function m(){const o=$("#opTypeCode").val();n=SETTINGS.opTypes.find(l=>l.code===o)}async function _(o){var l,c;swalLoading();try{await downloadFile(`${u()}/operations/card-activation-export-pdf`,"GET",{operation_id:o.id}),Swal.close()}catch(r){console.error(r);const a=((c=(l=r==null?void 0:r.error)==null?void 0:l.responseJSON)==null?void 0:c.message)||"Erreur export PDF";Swal.fire(a,"","error")}}function y(){if(console.log("[list.js] initDataTable()"),$.fn.DataTable.isDataTable("#table"))try{$("#table").DataTable().clear().destroy(!0)}catch(a){console.warn("[list.js] destroy warning:",a)}const o=$("#table");o.off(),o.html("<thead></thead><tbody></tbody>");const l=$("#table thead"),c=$(`
    <tr>
      <th>#</th>
      <th>Code</th>
      <th>Statut</th>
    </tr>
  `).appendTo(l),r=[{data:"__no__",name:"created_at"},{data:"code",name:"code",render:(a,t,e)=>`<a href="/operations/${n.code}/${e.id}">${a}</a>`},{data:"status",name:"status",render:a=>{const t=String(a??"");if(t.includes("<"))return t;const e=t.toLowerCase();return t==="pending"||e==="en attente"?'<span class="badge bg-secondary">En attente</span>':t==="approved"||e==="validée"||e==="validee"?'<span class="badge bg-success">Validée</span>':t==="rejected"||e==="rejetée"||e==="rejetee"?'<span class="badge bg-danger">Rejetée</span>':t}}];for(const[a,t]of n.sorted_fields)t.listed&&(n.code==="account_recharge"&&a==="trans_amount"&&(c.append("<th>Montant avant prélèvement</th><th>Frais (MomoPay)</th>"),r.push({data:e=>e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount/(1-.005):e.data.trans_amount,searchable:!1,orderable:!1,render:e=>formatAmount(e)},{data:e=>e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount*.005/(1-.005):0,searchable:!1,orderable:!1,render:e=>formatAmount(e)})),c.append(`<th>${a===n.amount_field?"Montant":t.label}</th>`),r.push({data:e=>{var s;return((s=e.data)==null?void 0:s[a])??""},searchable:!1,orderable:!1,render:e=>t.is_amount?formatAmount(e):e}));c.append("<th>Opérateur</th><th>Effectuée le</th>"),r.push({data:"partner",name:"partner",render:(a,t,e)=>USER.partner&&USER.partner.id===e.partner_id?`${a} (${e.partner_code})`:`${a} (<a href="/partners/${e.partner_id}">${e.partner_code}</a>)`},{data:"created_at",name:"created_at"}),window.datatable=$("#table").on("click",".export-card",function(){const a=window.datatable.row($(this).closest("tr")).data();_(a)}).on("click",".js-cancel-request",async function(){var e,s,d;const a=$(this).data("id");if((await Swal.fire({title:"Confirmer la demande ?",text:"Cette demande sera envoyée à l'administrateur.",icon:"warning",showCancelButton:!0,confirmButtonText:"Oui, envoyer",cancelButtonText:"Annuler"})).isConfirmed)try{swalLoading("Envoi de la demande...");const i={"X-CSRF-TOKEN":f()},p=await axios.post("/collab/operations-cancel",{operation_id:a},{headers:i});Swal.fire(((e=p==null?void 0:p.data)==null?void 0:e.message)||"Demande envoyée.","","success")}catch(i){console.error(i);const p=((d=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:d.message)||"Erreur pendant l’envoi.";Swal.fire(p,"","error")}}).DataTable({processing:!0,serverSide:!0,columns:r,order:[0,"desc"],ajax:{url:`${u()}/operations/${n.code}/list`,type:"POST",dataType:"json",data:a=>{a.operation_type_id=n.id,a.partner_id=$("#partnerId").val(),a.from_date=$("#fromDate").val(),a.to_date=$("#toDate").val(),a.status=$("#status").val(),a.card_type=$("#cardType").val()??"",a.uba_type=$("#ubaType").val()??"",Array.isArray(a.columns)||(a.columns=[]),["card_activation","card_recharge","card_deactivation"].includes(n.code)&&a.columns.push({data:"card_id",name:"card_id",searchable:!0,orderable:!1}),["canal_activation","canal_resub"].includes(n.code)&&a.columns.push({data:"decoder_number",name:"decoder_number",searchable:!0,orderable:!1})},error:a=>{var s,d;const t=(a==null?void 0:a.status)||((s=a==null?void 0:a.xhr)==null?void 0:s.status),e=((d=a==null?void 0:a.responseJSON)==null?void 0:d.message)||(a==null?void 0:a.responseText)||"Erreur chargement liste";console.error("[list.js] ajax error",{status:t,error:a}),Swal.fire(`${e}${t?` (HTTP ${t})`:""}`,"","error")},dataSrc:a=>{const t=((a==null?void 0:a.data)||[]).map(e=>{try{e.data=JSON.parse(e.data)}catch{}const d=String(e.status??"").replace(/<[^>]+>/g,"").trim();return e.__status_plain=d.toLowerCase(),e});return console.log("[list.js] dataSrc rows:",t.length),t}},pageLength:25,autoWidth:!1,deferLoading:0}),$("#table").wrap('<div style="overflow-x: auto;"></div>'),console.log("[list.js] DataTable ready -> typeof window.datatable =",typeof window.datatable)}async function h(){setTitle(`Liste des opérations «${n.name}»`),USER.hasRole("partner-pos")&&["balance_withdrawal"].includes(n.code)?$("#linkCreate").hide():$("#linkCreate").html('<i class="fas fa-plus"></i> Ajouter une nouvelle opération').attr("href",`/operations/${n.code}/create`),$("#exportExcel").click(async function(o){o.preventDefault(),swalLoading(),await downloadFile(`${u()}/operations/${n.code}/export-excel`,"GET",{partner_id:$("#partnerId").val()??"",from_date:$("#fromDate").val(),to_date:$("#toDate").val(),status:$("#status").val(),card_type:$("#cardType").val(),uba_type:$("#ubaType").val()}),Swal.close()}),$("#exportPdf").click(async function(o){o.preventDefault(),swalLoading(),await downloadFile(`${u()}/operations/${n.code}/export-pdf`,"GET",{partner_id:$("#partnerId").val()??"",from_date:$("#fromDate").val(),to_date:$("#toDate").val(),status:$("#status").val(),card_type:$("#cardType").val(),uba_type:$("#ubaType").val()}),Swal.close()}),$("#status, #partnerId, #fromDate, #toDate, #cardType, #ubaType").change(function(){window.datatable&&window.datatable.draw()}),$("#status").val($("#opStatus").val()).change(),USER.hasRole("partner")?$("#partnerId").parent().removeClass("d-flex").addClass("d-none"):populatePartners("#partnerId"),["card_activation","card_recharge","card_deactivation"].includes(n.code)?populateCardTypes("#cardType"):$("#cardType").parent().removeClass("d-flex").addClass("d-none"),USER.hasRole("partner")||n.code!=="card_activation"?$("#ubaType").parent().removeClass("d-flex").addClass("d-none"):populateUbaTypes("#ubaType")}window.render=async function(){console.log("[list.js] render()"),m(),y(),await h()};(function(){console.log("[list.js] loaded, autoBoot()"),document.readyState!=="loading"?window.render():document.addEventListener("DOMContentLoaded",()=>window.render(),{once:!0})})();
