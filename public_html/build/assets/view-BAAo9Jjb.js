let e=null,o=null;function d(){let t=$("#opTypeCode").val();o=SETTINGS.opTypes.find(a=>a.code===t)}async function u(){let t=$("#objectId").val();if(t)try{let{data:a}=await ajax({url:`${API_BASEURL}/operations/${o.code}/fetch/${t}`,type:"GET"});e=a}catch({error:a}){await Swal.fire(a.responseJSON.message,"","error"),location=`/operations/${o.code}`}}function m(){if(["account_recharge","balance_withdrawal"].includes(o.code))$("#blockCommissions").hide();else{let a=parseInt(e.amount),s=parseInt(e.fee),n=parseInt(e.commission);$("#amount").html(formatAmount(a)),$("#fee").html(formatAmount(s)),$("#totalAmount").html(formatAmount(a+s)),$("#commission").html(formatAmount(n)),$("#commissionPlatform").html(formatAmount(s>n?s-n:0))}switch($("#codePartner").html(e.partner.user.code),$("#firstName").html(e.partner.user.first_name),$("#lastName").html(e.partner.user.last_name),$("#companyName").html(e.company.name),$("#tin").html(e.company.tin),e.status){case"pending":$("#status").html('<span class="badge bg-secondary">En attente</span>');break;case"approved":$("#status").html('<span class="badge bg-success">Validée</span>');break;case"rejected":$("#status").html('<span class="badge bg-danger">Rejetée</span>');break}$("#reviewer").html(e.status==="pending"?"":`${e.reviewer.first_name} ${e.reviewer.last_name}`),$("#reviewedAt").html(e.status==="pending"?"":e.reviewed_at),$("#feedback").html(e.feedback?e.feedback:"");const t=$("#tableOperation tbody");for(const[a,s]of o.sorted_fields){if(a===o.amount_field)continue;let n=null;if((e.data[a]??null)===null)n="";else switch(s.type){case"select":case"text":case"textarea":case"email":case"date":case"datetime":n=e.data[a];break;case"number":n=s.is_amount?formatAmount(e.data[a]):e.data[a];break;case"file":n=`<a class="btn btn-outline-primary" target="_blank" href="${getUploadUrl(e.data[a])}">
          <i class="fas fa-eye"></i><a>`;break;case"card":n=e.data[a];break;case"country":n=`<img src="${getCountryFlagUrl(e.countries[a].code)}"> ${e.countries[a].name}`;break}o.code==="account_recharge"&&a==="trans_amount"&&t.append(`
        <tr>
          <th>Montant avant prélèvement</th>
          <td>${formatAmount(e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount/(1-.005):e.data.trans_amount)}</td>
        </tr>
        <tr>
          <th>Frais (MomoPay)</th>
          <td>${formatAmount(e.data.sender_phone_number_type==="MomoPay"?e.data.trans_amount*.005/(1-.005):0)}</td>
        </tr>
      `),o.code==="card_recharge"&&["client_first_name","client_last_name"].includes(a)&&(n=`<span class="fw-bold text-danger">${n}</span>`),t.append(`
      <tr>
        <th>${s.label}</th>
        <td>${n}</td>
      </tr>
    `)}USER.hasRole("reviewer")&&o.code==="card_activation"&&e.duplicates&&$("#alertMessage").html(`Ce client a déjà fait l'object ${e.duplicates===1?"d'une autre activation de carte approuvée":`de ${e.duplicates} autres activations de cartes approuvées`}`).show()}async function p(){try{let t=await Swal.fire({title:`Voulez-vous vraiment valider l'opération ${o.name} ${e.code}?`,text:"Cette opération est irreversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();let{data:a}=await ajax({url:`${API_BASEURL}/operations/${o.code}/approve/${e.id}`,type:"POST",data:{feedback:t.value,without_commission:!1}});Toast.fire(a.message,"","success"),location.reload()}catch({error:t}){Swal.fire(t.responseJSON.message,"","error")}}async function f(){try{let t=await Swal.fire({title:`Voulez-vous vraiment valider l'opération ${o.name} ${e.code} sans les commissions?`,text:"Cette opération est irreversible. Et le partenaire ne recevra pas de commissions.",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();let{data:a}=await ajax({url:`${API_BASEURL}/operations/${o.code}/approve/${e.id}`,type:"POST",data:{feedback:t.value,without_commission:!0}});Toast.fire(a.message,"","success"),location.reload()}catch({error:t}){Swal.fire(t.responseJSON.message,"","error")}}async function h(){try{let t=await Swal.fire({title:`Voulez-vous vraiment rejeter l'opération ${o.name} ${e.code}?`,text:"Cette opération est irreversible",input:"textarea",inputPlaceholder:"Vous pouvez laisser un feedback ici...",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"});if(!t.isConfirmed)throw{};swalLoading();let{data:a}=await ajax({url:`${API_BASEURL}/operations/${o.code}/reject/${e.id}`,type:"POST",data:{feedback:t.value}});Toast.fire(a.message,"","success"),location.reload()}catch({error:t}){Swal.fire(t.responseJSON.message,"","error")}}async function w(){try{if(!(await Swal.fire({title:`Voulez-vous vraiment supprimer l'opération ${o.name} ${e.code}?`,text:"Cette opération est irreversible",icon:"question",showCancelButton:!0,confirmButtonText:"Oui",cancelButtonText:"Non"})).isConfirmed)throw{};swalLoading();let{data:a}=await ajax({url:`${API_BASEURL}/operations/${o.code}/delete/${e.id}`,type:"POST"});Toast.fire(a.message,"","success"),location=`/operations/${o.code}`}catch({error:t}){Swal.fire(t.responseJSON.message,"","error")}}function b(){if(typeof $>"u"||typeof Swal>"u")return;const t=typeof(USER==null?void 0:USER.hasRole)=="function"&&USER.hasRole("collab"),a=!!e&&e.status==="approved",s=$(".card-header h4").filter(function(){return $(this).text().trim()==="Actions"}).closest(".card").find(".card-body").first();if(console.log("[cancel-btn] isCollab:",t,"status:",e==null?void 0:e.status,"actionsCardBody.length:",s.length),!(!t||!a||!s.length)&&!$("#btnCancelOp").length){const n=$(`
      <button type="button" class="btn btn-lg btn-outline-danger ms-2" id="btnCancelOp">
        <i class="fas fa-undo me-2"></i> Demander l'annulation
      </button>
    `);s.append(n),$("#btnCancelOp").on("click",async function(){var c;const r=$('meta[name="csrf-token"]').attr("content")||"";if((await Swal.fire({title:"Confirmer",text:"Voulez-vous envoyer une demande d'annulation pour cette opération ?",icon:"question",showCancelButton:!0,confirmButtonText:"Oui, envoyer",cancelButtonText:"Annuler"})).isConfirmed){Swal.fire({title:"Envoi en cours...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{const i=await $.ajax({url:"/collab/operations-cancel",method:"POST",dataType:"json",headers:r?{"X-CSRF-TOKEN":r}:{},data:{operation_id:e.id}});Swal.fire((i==null?void 0:i.message)||"Demande envoyée.","","success")}catch(i){const l=((c=i==null?void 0:i.responseJSON)==null?void 0:c.message)||(i==null?void 0:i.message)||"Erreur pendant l'envoi de la demande.";Swal.fire(l,"","error")}}})}}window.render=async function(){d(),await u(),setTitle(`${o.name} ${e.code}`),$("#linkList").html('<i class="fas fa-list"></i> Liste des opérations').attr("href",`/operations/${o.code}`),m(),b(),$("#edit").click(function(t){location=`/operations/${o.code}/${e.id}/edit`}),$("#approve").click(function(t){p()}),$("#approveWithoutCommission").click(function(t){f()}),$("#reject").click(function(t){h()}),$("#delete").click(function(t){w()}),e.status!=="rejected"&&$("#edit").hide(),e.status!=="pending"&&($("#approve").hide(),$("#reject").hide()),(e.status!=="pending"||["account_recharge","balance_withdrawal"].includes(o.code)||!hasCommissions(e.master,o.id,e.data.card_type||null)&&o.code!=="card_activation")&&$("#approveWithoutCommission").hide()};
