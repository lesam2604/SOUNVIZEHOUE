window.datatableProducts=null;window.selectedProduct=null;window.selectedProductRow=null;window.populateProductAdding=async function(e=null){try{e||(e=(await ajax({url:`${API_BASEURL}/inv-products/fetch-all`,type:"GET"})).data),$("#invProductId").empty();for(const t of e)$("#invProductId").append(`<option value="${t.id}" data-code="${t.code}"
        data-category="${t.category.name}" data-unit_price="${t.unit_price}">${t.name}</option>`)}catch({error:t}){await Swal.fire(t.responseJSON.message,"","error")}};window.clearProductAdding=function(){$("#invProductId").val("").prop("disabled",!1),$("#quantity").val("0"),datatableProducts.clear().draw()};window.setProductAdding=function(e){$("#invProductId").val("").change(),$("#quantity").val(""),datatableProducts.clear();for(const t of e)datatableProducts.row.add({product_id:t.id,code:t.code,name:t.name,category_name:t.category.name,unit_price:t.pivot.unit_price,quantity:t.pivot.quantity,total_cost:t.pivot.unit_price*t.pivot.quantity});datatableProducts.draw()};window.fillProductAdding=function(e){return e.products=JSON.stringify(datatableProducts.rows().data().toArray().map(t=>({id:t.product_id,quantity:t.quantity}))),e};window.initDataTableProducts=function(){datatableProducts=$("#tableProducts").on("click",".edit",function(e){selectedProductRow=$(this).closest("tr"),selectedProduct=datatableProducts.row(selectedProductRow).data(),$("#invProductId").val(selectedProduct.product_id).prop("disabled",!0),$("#quantity").val(selectedProduct.quantity)}).on("click",".remove",function(e){datatableProducts.row($(this).closest("tr")).remove().draw(!1)}).DataTable({columns:[{data:"code"},{data:"name"},{data:"category_name"},{data:"unit_price",render:(e,t,a)=>formatAmount(e)},{data:"quantity"},{data:"total_cost",render:(e,t,a)=>formatAmount(e)},{orderable:!1,render:(e,t,a)=>`
              <div class="d-flex">
                <button type="button" class="btn btn-sm btn-primary m-1 edit"><i class="fas fa-edit"></i> Éditer</button>
                <button type="button" class="btn btn-sm btn-danger m-1 remove"><i class="fas fa-minus"></i> Retirer</button>
              </div>
            `}],order:[0,"desc"],pageLength:-1,autoWidth:!1}),$("#tableProducts").wrap('<div style="overflow-x: auto;"></div>')};window.initProductAdding=function(){initDataTableProducts(),$("#addProduct").click(function(e){let t=$("#invProductId").find("option:selected"),a=parseInt(t.attr("value")),d=parseInt($("#quantity").val());if(selectedProduct===null){if(!a){Swal.fire("Veuillez sélectionner un produit","","error");return}if(datatableProducts.rows().data().filter(n=>n.product_id===a).length>0){Swal.fire("Ce produit figure déjà sur la liste","","error");return}if(d<=0){Swal.fire("La quantité n'est pas valide","","error");return}let o=parseInt(t.data("unit_price"));datatableProducts.row.add({product_id:a,code:t.data("code"),name:t.text(),category_name:t.data("category"),unit_price:o,quantity:d,total_cost:o*d})}else{let r=selectedProduct.unit_price*d;selectedProduct.quantity=d,selectedProduct.total_cost=r,datatableProducts.row(selectedProductRow).data(selectedProduct),selectedProductRow=null,selectedProduct=null}datatableProducts.draw(!1),$("#invProductId").val("").prop("disabled",!1),$("#quantity").val("0")})};
